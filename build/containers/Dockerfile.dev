## 1. Build the base image. This build is a rare event.
FROM python:3.9.13-slim-buster as base
ENV PYTHONFAULTHANDLER=1 \
    PYTHONHASHSEED=random \
    PYTHONUNBUFFERED=1
WORKDIR /app
RUN apt-get update && apt-get install -y make git curl && curl -sL https://deb.nodesource.com/setup_16.x | bash -
RUN apt-get install -y nodejs && apt-get remove -y curl && rm -rf /var/lib/apt/lists/*

## 2. bring build tools
FROM base as build

# Setup build environment
ARG WHICH_ENV
ENV WHICH_ENV=${WHICH_ENV} \
  PYTHONFAULTHANDLER=1 \
  PYTHONUNBUFFERED=1 \
  PYTHONHASHSEED=random \
  PIP_NO_CACHE_DIR=1 \
  PIP_DISABLE_PIP_VERSION_CHECK=1 \
  PIP_DEFAULT_TIMEOUT=100 \
  POETRY_VERSION=1.2.1

# Install all dependencies. Python venv 
RUN pip install "poetry==$POETRY_VERSION"
RUN python -m venv /venv
COPY pyproject.toml poetry.lock ./
RUN poetry export --without-hashes --with dev -f requirements-dev.txt | /venv/bin/pip install -r /dev/stdin

# Save only the binaries
COPY . .
RUN poetry build && /venv/bin/pip install dist/*.whl

## Finalize the image

FROM base as final
COPY --from=build /venv /venv

# Install Node dependencies.
COPY ./package* ./
RUN npm ci

# Install code
CMD ["./scripts/run_devserver_docker.sh"]
